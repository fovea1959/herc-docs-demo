

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Adding New z/Architecture Facilities to Hercules &mdash; Hercules Documentation Demo 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link href="_static/herc_style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Hercules Documentation Demo
          

          
          </a>

          
            
            
              <div class="version">
                fovea1959
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hercinst.html">Building and Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration File</a></li>
<li class="toctree-l1"><a class="reference internal" href="hercdasd.html">Creating DASD</a></li>
<li class="toctree-l1"><a class="reference internal" href="hercoper.html">Operating Procedure</a></li>
<li class="toctree-l1"><a class="reference internal" href="hercsupp.html">Technical Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="hercfaq.html">Frequently-Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="messages.html">Messages and Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="aa_auxdocs.html">Supporting documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix_a.html">Appendix A - Documentation Standards</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Hercules Documentation Demo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Adding New z/Architecture Facilities to Hercules</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/README.FACILITIES.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="adding-new-z-architecture-facilities-to-hercules">
<h1>Adding New z/Architecture Facilities to Hercules<a class="headerlink" href="#adding-new-z-architecture-facilities-to-hercules" title="Permalink to this heading">¶</a></h1>
<p>IBM’s z/Architecture supports the concept of Facilities, many of which
have a corresponding facility list bit assigned to them, available to
the program via the STORE FACILITY LIST EXTENDED (STFLE) instruction.</p>
<p>Hercules’s support of z/Architecture facilities is controlled by the
<code class="docutils literal notranslate"><span class="pre">facility.c</span></code>, <code class="docutils literal notranslate"><span class="pre">stfl.h</span></code>, <code class="docutils literal notranslate"><span class="pre">feat900.h</span></code> and <code class="docutils literal notranslate"><span class="pre">featchk.h</span></code> source
files:</p>
<ul class="simple">
<li><p>  <a class="reference external" href="../stfl.h">stfl.h</a>              defines the actual STFLE
facility list bits themselves</p></li>
<li><p>  <a class="reference external" href="../feat900.h">feat900.h</a>       defines the <code class="docutils literal notranslate"><span class="pre">FEATURE...</span></code> build
macros</p></li>
<li><p>  <a class="reference external" href="../featchk.h">featchk.h</a>       enforces <code class="docutils literal notranslate"><span class="pre">FEATURE...</span></code> build
macro sanity</p></li>
<li><p>  <a class="reference external" href="../facility.c">facility.c</a>         implements the <code class="docutils literal notranslate"><span class="pre">facility</span></code>
command and table-based control of facility bits and instructions</p></li>
</ul>
<section id="defining-the-stfle-feature-bits">
<h2>2. Defining the STFLE feature bits<a class="headerlink" href="#defining-the-stfle-feature-bits" title="Permalink to this heading">¶</a></h2>
<p>The <a class="reference external" href="../stfl.h">stfl.h</a> header defines the actual STFLE feature bits
themselves. The <code class="docutils literal notranslate"><span class="pre">#define</span></code> macros contain the bit numbers in their name
since many of the defined facilities have very similar names. This
reduces the likelihood of using the wrong macro name in the code.</p>
<p>The <a class="reference external" href="../stfl.h">stfl.h</a> header looks like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define STFL_000_N3_INSTR              0    </span><span class="cm">/* Instructions marked N3</span>
<span class="cm">                                               are installed             */</span>
<span class="cp">#define STFL_001_ZARCH_INSTALLED       1    </span><span class="cm">/* z/Arch mode is available on</span>
<span class="cm">                                               this processor            */</span>
<span class="cp">#define STFL_002_ZARCH_ACTIVE          2    </span><span class="cm">/* z/Architecture architecural</span>
<span class="cm">                                               mode active. When bit 2 and</span>
<span class="cm">                                               168 are both zero, ESA/390</span>
<span class="cm">                                               mode is active. When bit 2</span>
<span class="cm">                                               is zero and bit 168 is one,</span>
<span class="cm">                                               ESA/390-compatibility mode</span>
<span class="cm">                                               is active.                */</span>
<span class="cp">#define STFL_003_DAT_ENHANCE_1         3    </span><span class="cm">/* DAT-Enhancement Facility 1</span>
<span class="cm">                                               is installed.             */</span>
<span class="cp">#define STFL_004_IDTE_SC_SEGTAB        4    </span><span class="cm">/* IDTE selective clearing</span>
<span class="cm">                                               when segtab invalidated. Bit</span>
<span class="cm">                                               3 is one if bit 4 is one. */</span>
<span class="p">...</span><span class="n">etc</span><span class="p">...</span>

<span class="cp">#define STFL_153_UNASSIGNED          153    </span><span class="cm">/* Unassigned                */</span>

<span class="cp">#define STFL_154_UNASSIGNED          154    </span><span class="cm">/* Unassigned                */</span>

<span class="cp">#define STFL_155_MSA_EXTENSION_9     155    </span><span class="cm">/* Message-security-assist-</span>
<span class="cm">                                               extension-9 installed.</span>
<span class="cm">                                               Bits 76 and 77 are one</span>
<span class="cm">                                               when bit 155 is one.      */</span>

<span class="cp">#define STFL_156_IBM_INTERNAL        156    </span><span class="cm">/* IBM internal use          */</span>

<span class="c1">//efine STFL_nnn_UNASSIGNED      157-167    /* Unassigned or IBM internal*/</span>

<span class="cp">#define STFL_168_ESA390_COMPAT_MODE  168    </span><span class="cm">/* ESA/390-compatibility-mode.</span>
<span class="cm">                                               Bit 168 can only be 1 when</span>
<span class="cm">                                               bit 2 is zero.            */</span>

<span class="cp">#define STFL_IBM_LAST_BIT            168    </span><span class="cm">/* Last defined IBM facility */</span>

<span class="cp">#define STFL_IBM_BY_SIZE        (ROUND_UP( STFL_IBM_LAST_BIT, 8 ) / 8)</span>
<span class="cp">#define STFL_IBM_DW_SIZE        (ROUND_UP( STFL_IBM_BY_SIZE, sizeof( DW )) / sizeof( DW ))</span>
</pre></div>
</div>
<p><strong>Please note</strong> the comments on some of the definitions (e.g.
<code class="docutils literal notranslate"><span class="pre">&quot;Bits</span> <span class="pre">76</span> <span class="pre">and</span> <span class="pre">77</span> <span class="pre">are</span> <span class="pre">one</span> <span class="pre">when</span> <span class="pre">bit</span> <span class="pre">155</span> <span class="pre">is</span> <span class="pre">one&quot;</span></code>). It is <strong>very
important</strong> to document such conditions as their enforcement is one of
the primary purposes of the <code class="docutils literal notranslate"><span class="pre">facility</span></code> command, controlled via the
<code class="docutils literal notranslate"><span class="pre">`FT2</span></code> table &lt;#5b-The-FT2-table&gt;`__ and corresponding <code class="docutils literal notranslate"><span class="pre">`modnnn</span></code>
functions &lt;#5c-modnnn-Modification-Check-Functions&gt;`__.</p>
</section>
<section id="defining-the-feat900-feature-build-macros">
<h2>3. Defining the feat900 <code class="docutils literal notranslate"><span class="pre">FEATURE</span></code> build macros<a class="headerlink" href="#defining-the-feat900-feature-build-macros" title="Permalink to this heading">¶</a></h2>
<p>Our <code class="docutils literal notranslate"><span class="pre">FEATURE...</span></code> build macros control actual code generation for a
given build architecture according to whether the macro is defined or
not in each architecture’s “feature” header
(e.g. <a class="reference external" href="../feat370.h">feat370.h</a> for System/370,
<a class="reference external" href="../feat390.h">feat390.h</a> for ESA/390 or <a class="reference external" href="../feat900.h">feat900.h</a>
for z/Architecture).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">FEATURE_xxx...</span></code> #defines for facilities contain the bit numbers
in their name, just like the <code class="docutils literal notranslate"><span class="pre">STFL_xxx...</span></code> #defines in header
<a class="reference external" href="../stfl.h">stfl.h</a> do:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>

<span class="cp">#define FEATURE_037_FP_EXTENSION_FACILITY                       </span><span class="cm">/*@SRO*/</span>
<span class="c1">//efine FEATURE_038_OP_CMPSC_FACILITY</span>
<span class="cp">#define FEATURE_040_LOAD_PROG_PARAM_FACILITY</span>
<span class="cp">#define FEATURE_041_DFP_ROUNDING_FACILITY</span>
<span class="cp">#define FEATURE_041_FPR_GR_TRANSFER_FACILITY</span>
<span class="cp">#define FEATURE_041_FPS_ENHANCEMENT_FACILITY</span>
<span class="cp">#define FEATURE_041_FPS_SIGN_HANDLING_FACILITY</span>
<span class="cp">#define FEATURE_041_IEEE_EXCEPT_SIM_FACILITY</span>
<span class="cp">#define FEATURE_042_DFP_FACILITY                                </span><span class="cm">/*DFP*/</span>
<span class="cp">#define FEATURE_043_DFP_HPERF_FACILITY</span>

<span class="p">...</span><span class="n">etc</span><span class="p">...</span>
</pre></div>
</div>
</section>
<section id="verifying-feature-build-macro-sanity">
<h2>4. Verifying <code class="docutils literal notranslate"><span class="pre">FEATURE</span></code> build macro sanity<a class="headerlink" href="#verifying-feature-build-macro-sanity" title="Permalink to this heading">¶</a></h2>
<p>The <a class="reference external" href="../featchk.h">featchk.h</a> header not only #defines our
all-important <code class="docutils literal notranslate"><span class="pre">_FEATURE_xxx...</span></code> <strong>underscore</strong> macros (depending on
whether or not the given feature is #defined for <em>any</em> of the build
architectures), but also enforces feature definition sanity.</p>
<p>For example, it checks to make sure that if the
Constrained-Transactional-Execution Facility FEATURE is #defined, that
the Transactional-Execution Facility FEATURE is also #defined:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined( FEATURE_050_CONSTR_TRANSACT_FACILITY )</span>
<span class="w"> </span><span class="cp">#define    _FEATURE_050_CONSTR_TRANSACT_FACILITY</span>
<span class="cp">#endif</span>

<span class="p">...</span>

<span class="cp">#if defined( FEATURE_073_TRANSACT_EXEC_FACILITY )</span>
<span class="w"> </span><span class="cp">#define    _FEATURE_073_TRANSACT_EXEC_FACILITY</span>
<span class="cp">#endif</span>

<span class="p">...</span>

<span class="cp">#if defined( FEATURE_050_CONSTR_TRANSACT_FACILITY ) &amp;&amp; !defined( FEATURE_073_TRANSACT_EXEC_FACILITY )</span>
<span class="w"> </span><span class="cp">#error Constrained-transactional-execution facility requires Transactional-execution facility</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>The same facility dependency concept (one facility being dependent on,
or implying, another) is also enforced at runtime (but accomplished
differently of course) by the
<code class="docutils literal notranslate"><span class="pre">`modnnn</span></code> &lt;#5c-modnnn-Modification-Check-Functions&gt;`__ function
declared in the facility’s <code class="docutils literal notranslate"><span class="pre">`FT2</span></code> &lt;#5b-The-FT2-table&gt;`__ table entry.</p>
</section>
<section id="defining-the-facility-c-run-time-tables-and-functions">
<h2>5. Defining the facility-c run-time tables and functions<a class="headerlink" href="#defining-the-facility-c-run-time-tables-and-functions" title="Permalink to this heading">¶</a></h2>
<p>The code in <a class="reference external" href="../facility.c">facility.c</a> controls virtually all
aspects of Hercules’s facility support, creating (initializing) the
facility list bit strings in SYSBLK, allowing user control over the
setting or clearing (enabling or disabling) of any given facility via
the <code class="docutils literal notranslate"><span class="pre">facility</span></code> command, as well disabling or enabling instructions
associated with a given facility.</p>
<section id="a-the-ft-table">
<h3>5a. The <code class="docutils literal notranslate"><span class="pre">FT</span></code> table<a class="headerlink" href="#a-the-ft-table" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">FT</span></code> table is an architecture <em>dependent</em> table that gets built
differently for each #defined build architecture (<code class="docutils literal notranslate"><span class="pre">OPTION_370_MODE</span></code>,
<code class="docutils literal notranslate"><span class="pre">OPTION_390_MODE</span></code> and <code class="docutils literal notranslate"><span class="pre">OPTION_900_MODE</span></code>) depending on which
<code class="docutils literal notranslate"><span class="pre">FEATURE_999_XXX...</span></code> facilities are #defined for each build
architecture.</p>
<p>During Hercules startup and initialization,
<a class="reference external" href="../bldcfg.c">bldcfg.c</a>’s <code class="docutils literal notranslate"><span class="pre">build_config</span></code> function calls into
<a class="reference external" href="../facility.c">facility.c</a>’s <code class="docutils literal notranslate"><span class="pre">init_facilities_lists</span></code> function to
initialize the <code class="docutils literal notranslate"><span class="pre">sysblk.facility_list</span></code> variable in <code class="docutils literal notranslate"><span class="pre">SYSBLK</span></code>. It first
merges the three separate architecture <em>dependent</em> <code class="docutils literal notranslate"><span class="pre">FT</span></code> tables into
one master internal architecture <em>independent</em> table called <code class="docutils literal notranslate"><span class="pre">factab</span></code>
(the <code class="docutils literal notranslate"><span class="pre">`FT2</span></code> table &lt;#5b-The-FT2-table&gt;`__ controls this merging), and
it is this master <code class="docutils literal notranslate"><span class="pre">factab</span></code> table that is then used to initialize each
architecture’s <code class="docutils literal notranslate"><span class="pre">sysblk.facility_list</span></code> variable in <code class="docutils literal notranslate"><span class="pre">SYSBLK</span></code> depending
on whether the given facility is enabled or not for that particular
architecture or not.</p>
<p>The format of the <code class="docutils literal notranslate"><span class="pre">FT</span></code> table is quite simple:</p>
<ul class="simple">
<li><p><strong>Supported:</strong>     which architecture(s) the given facility applies
to</p></li>
<li><p><strong>Default:</strong>          which architecture(s) have the facility enabled
by default</p></li>
<li><p><strong>Required:</strong>       which architecture(s) REQUIRE the facility (which
prevents it from being disabled)</p></li>
<li><p><strong>Short name:</strong>   the abbreviated “name” of the facility as used by
the <code class="docutils literal notranslate"><span class="pre">FACILITY_ENABLED</span></code> macro (which is just the
<a class="reference external" href="../stfl.h">stfl.h</a> header #define name without the “STFL_”):</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/*              Temporary ARCH_DEP Facility Table                    */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>

<span class="k">static</span><span class="w"> </span><span class="n">FACTAB</span><span class="w"> </span><span class="n">ARCH_DEP</span><span class="p">(</span><span class="w"> </span><span class="n">facs_tab</span><span class="w"> </span><span class="p">)[]</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="cm">/* Arch-DEPENDENT table  */</span>
<span class="p">{</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/*  Sup   Def   Req   Short Name...                                  */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>

<span class="p">...</span>

<span class="cp">#if defined(  FEATURE_018_LONG_DISPL_INST_FACILITY )</span>
<span class="n">FT</span><span class="p">(</span><span class="w"> </span><span class="n">Z90X</span><span class="p">,</span><span class="w"> </span><span class="n">Z900</span><span class="p">,</span><span class="w"> </span><span class="n">Z900</span><span class="p">,</span><span class="w"> </span><span class="mo">01</span><span class="mi">8</span><span class="n">_LONG_DISPL_INST</span><span class="w"> </span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="p">...</span><span class="n">etc</span><span class="p">...</span>
</pre></div>
</div>
<p>The <strong>Sup</strong> (Supported), <strong>Def</strong> (Default) and <strong>Req</strong> (Required)
parameters use one of eight defined values #defined at the very
beginning of <a class="reference external" href="../facility.c">facility.c</a>:</p>
<ul class="simple">
<li><p>  <strong>NONE</strong>     (no architectures or facility disabled)</p></li>
<li><p>  <strong>S370</strong>       (S/370 only)</p></li>
<li><p>  <strong>E390</strong>       (ESA/390 only)</p></li>
<li><p>  <strong>Z900</strong>       (z/Arch only)</p></li>
<li><p>  <strong>Z390</strong>       (both ESA/390 and z/Arch)</p></li>
<li><p>  <strong>Z39X</strong>       (E390 + Z900 + optionally S370)</p></li>
<li><p>  <strong>Z90X</strong>       (Z900 + optionally S370)</p></li>
<li><p>  <strong>MALL</strong>      (all architectures)</p></li>
</ul>
</section>
<section id="b-the-ft2-table">
<h3>5b. The <code class="docutils literal notranslate"><span class="pre">FT2</span></code> table<a class="headerlink" href="#b-the-ft2-table" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">FT2</span></code> table defines additional information for each facility
defined to the system, such as the name of the facility’s
<code class="docutils literal notranslate"><span class="pre">`modnnn</span></code> &lt;#5c-modnnn-Modification-Check-Functions&gt;`__ Modification
Check function, the name of the facility’s
<code class="docutils literal notranslate"><span class="pre">`instrxxx</span></code> &lt;#5d-instrxxx-Update-Opcode-Table-functions&gt;`__ Update
Opcode Table function and the facility’s “Long” name (description).</p>
<p>The information in the <code class="docutils literal notranslate"><span class="pre">FT2</span></code> table is “merged” with each
architecture’s <code class="docutils literal notranslate"><span class="pre">`FT</span></code> &lt;#5a-The-FT-table&gt;`__ table (by the
<code class="docutils literal notranslate"><span class="pre">init_facilities_lists</span></code> function called by
<a class="reference external" href="../bldcfg.c">bldcfg.c</a>’s <code class="docutils literal notranslate"><span class="pre">build_config</span></code> function during Hercules
startup and initialization) to create the master <code class="docutils literal notranslate"><span class="pre">factab</span></code> table used
to initialize the <code class="docutils literal notranslate"><span class="pre">sysblk.facility_list</span></code> variable in <code class="docutils literal notranslate"><span class="pre">SYSBLK</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">`modnnn</span></code> &lt;#5c-modnnn-Modification-Check-Functions&gt;`__ parameter
defines the name of the facility’s Modification Check function which
defines the function that controls the enabling and disabling of that
particular facility bit when the given facility requires or implies one
or more other facility bits also being set. Refer to the next section
just below for more information about the
<code class="docutils literal notranslate"><span class="pre">`modnnn</span></code> &lt;#5c-modnnn-Modification-Check-Functions&gt;`__ Modification
Check function.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">`instrxxx</span></code> &lt;#5d-instrxxx-Update-Opcode-Table-functions&gt;`__ Update
Opcode Table function parameter defines the function which controls the
enabling or disabling of the actual instructions themselves defined by
the facility. That is to say, certain facilities define new
z/Architecture instructions which only exist if that given facility
exists (i.e. if that particular facility list bit is one). If the
facility doesn’t exist (i.e. if the facility list bit is off or zero),
then the instructions that facility introduced do not exist, and
attempts to execute such instructions cause an immediate “Operation
Exception” Program Check interruption.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/* The ACTUAL facilities table, initialized by init_facilities_lists */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/*  The individual ARCH_DEP( facs_tab ) tables are merged into this  */</span>
<span class="cm">/*  table to yield the actual facilities table the system will use.  */</span>
<span class="cm">/*  Refer to init_facilities_lists() function for how this is done.  */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>

<span class="k">static</span><span class="w"> </span><span class="n">FACTAB</span><span class="w"> </span><span class="n">factab</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="cm">/*----------------------------------------------------------------------------*/</span>
<span class="cm">/*   (func)   (func)    Short Name...          Long Description...            */</span>
<span class="cm">/*----------------------------------------------------------------------------*/</span>

<span class="p">...</span>

<span class="n">FT2</span><span class="p">(</span><span class="w"> </span><span class="n">mod018</span><span class="p">,</span><span class="w">  </span><span class="n">instr18</span><span class="p">,</span><span class="w">  </span><span class="mo">01</span><span class="mi">8</span><span class="n">_LONG_DISPL_INST</span><span class="p">,</span><span class="w">   </span><span class="s">&quot;Long-Displacement Facility&quot;</span><span class="w"> </span><span class="p">)</span>
<span class="n">FT2</span><span class="p">(</span><span class="w"> </span><span class="n">mod019</span><span class="p">,</span><span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w">     </span><span class="mo">01</span><span class="mi">9</span><span class="n">_LONG_DISPL_HPERF</span><span class="p">,</span><span class="w">  </span><span class="s">&quot;Long-Displacement Facility Has High Performance&quot;</span><span class="w"> </span><span class="p">)</span>

<span class="p">...</span><span class="n">etc</span><span class="p">...</span>

<span class="n">FT2</span><span class="p">(</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w">    </span><span class="n">instr21</span><span class="p">,</span><span class="w">  </span><span class="mo">021</span><span class="n">_EXTENDED_IMMED</span><span class="p">,</span><span class="w">    </span><span class="s">&quot;Extended-Immediate Facility&quot;</span><span class="w"> </span><span class="p">)</span>

<span class="p">...</span><span class="n">etc</span><span class="p">...</span>
</pre></div>
</div>
<p>The “Long name” is simply the official descriptive name of the given
facility and is used by the <code class="docutils literal notranslate"><span class="pre">facility</span></code> command when a display of the
available facilities is requested. (The <code class="docutils literal notranslate"><span class="pre">facility</span></code> command supports
listing available facilities by either SHORT or LONG name.)</p>
</section>
<section id="c-modnnn-modification-check-functions">
<h3>5c. <code class="docutils literal notranslate"><span class="pre">modnnn</span></code> Modification Check functions<a class="headerlink" href="#c-modnnn-modification-check-functions" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">modnnn</span></code> Modification Check functions are defined in the
<code class="docutils literal notranslate"><span class="pre">`FT2</span></code> &lt;#5b-The-FT2-table&gt;`__ table entries and control the enabling
or disabling of a given facility for those facilities which are
dependent on one or more other facilities.</p>
<p>For example, facility 18 is the “Long-Displacement Facility” and
facility 19 is the “Long-Displacement Facility Has High Performance”
facility. If the “Long-Displacement Facility Has High Performance” (bit
19) is enabled then it follows that the “Long-Displacement Facility”
(bit 18) must necessarily also be enabled. That is to say, you cannot
have facility 19 enabled without facility 18 also being enabled.</p>
<p>On the other hand, you <em>may</em> have facility 18 enabled but <em>not</em> facility
19. That is allowed. But having 19 enabled without <em>also</em> having 18
enabled too, is <strong>invalid</strong>.</p>
<p>It is the <code class="docutils literal notranslate"><span class="pre">modnnn</span></code> Modification Check function’s job to enforce such
restrictions, and such functions are defined in the first parameter of
the <code class="docutils literal notranslate"><span class="pre">`FT2</span></code> &lt;#5b-The-FT2-table&gt;`__ table. The actual function itself
that does the enforcement looks like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w">  </span><span class="kt">bool</span><span class="w">  </span><span class="nf">mod018</span><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bitno</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">archnum</span><span class="p">,</span><span class="w"> </span><span class="p">...</span>
<span class="k">static</span><span class="w">  </span><span class="kt">bool</span><span class="w">  </span><span class="n">mod019</span><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bitno</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">archnum</span><span class="p">,</span><span class="w"> </span><span class="p">...</span>

<span class="p">...</span>

<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/*                          mod018                                   */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/*                       required by 19                              */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="n">FAC_MOD_OK_FUNC</span><span class="w">           </span><span class="p">(</span><span class="w"> </span><span class="n">mod018</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span><span class="w"> </span><span class="c1">// disabling</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FACILITY_ENABLED_ARCH</span><span class="p">(</span><span class="w"> </span><span class="mo">01</span><span class="mi">9</span><span class="n">_LONG_DISPL_HPERF</span><span class="p">,</span><span class="w"> </span><span class="n">archnum</span><span class="w"> </span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">HHC00890E</span><span class="p">(</span><span class="w"> </span><span class="n">STFL_019_LONG_DISPL_HPERF</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/*                          mod019                                   */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/*                     also requires 18                              */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="n">FAC_MOD_OK_FUNC</span><span class="w">           </span><span class="p">(</span><span class="w"> </span><span class="n">mod019</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">enable</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">FACILITY_ENABLED_ARCH</span><span class="p">(</span><span class="w"> </span><span class="mo">01</span><span class="mi">8</span><span class="n">_LONG_DISPL_INST</span><span class="p">,</span><span class="w"> </span><span class="n">archnum</span><span class="w"> </span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">HHC00890E</span><span class="p">(</span><span class="w">  </span><span class="n">STFL_018_LONG_DISPL_INST</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Please note</strong> that the above functions not only prevent enabling bit
19 unless bit 18 is first enabled, but also prevents bit 18 from being
<em>disabled</em> as well, unless bit 19 is first disabled beforehand.</p>
<p><strong>For reference</strong>, I have manually created the following tables which
documents the various interfacility dependencies according to the <em>May
2022</em> version of manual SA22-7832-<strong>13</strong> <em>“z/Architecture Principles of
Operation”</em>:</p>
<center></section>
<section id="facility-dependencies">
<h3>Facility Dependencies<a class="headerlink" href="#facility-dependencies" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Bit</p></th>
<th class="head"><p>Requires …</p></th>
<th class="head"><p>Required <em>by</em> …</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>000</p></td>
<td></td>
<td><p>007</p></td>
</tr>
<tr class="row-odd"><td><p>003</p></td>
<td></td>
<td><p>004, 005</p></td>
</tr>
<tr class="row-even"><td><p>004</p></td>
<td><p>003</p></td>
<td><p>005</p></td>
</tr>
<tr class="row-odd"><td><p>005</p></td>
<td><p>003, 004</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>007</p></td>
<td><p>000</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>008</p></td>
<td></td>
<td><p>078</p></td>
</tr>
<tr class="row-even"><td><p>014</p></td>
<td></td>
<td><p>149</p></td>
</tr>
<tr class="row-odd"><td><p>018</p></td>
<td></td>
<td><p>019</p></td>
</tr>
<tr class="row-even"><td><p>019</p></td>
<td><p>018</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>025</p></td>
<td></td>
<td><p>139</p></td>
</tr>
<tr class="row-even"><td><p>028</p></td>
<td></td>
<td><p>139</p></td>
</tr>
<tr class="row-odd"><td><p>037</p></td>
<td><p>042</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>``
+``
040</p></td>
<td></td>
<td><p>068</p></td>
</tr>
<tr class="row-odd"><td><p>042</p></td>
<td></td>
<td><p>037, 043</p></td>
</tr>
<tr class="row-even"><td><p>043</p></td>
<td><p>042</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>045</p></td>
<td></td>
<td><p>061</p></td>
</tr>
<tr class="row-even"><td><p>048</p></td>
<td><p>042</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>049</p></td>
<td></td>
<td><p>073, 081</p></td>
</tr>
<tr class="row-even"><td><p>050</p></td>
<td><p>073</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>051</p></td>
<td></td>
<td><p>194</p></td>
</tr>
<tr class="row-even"><td><p>061</p></td>
<td><p>045</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>``
+``
067</p></td>
<td></td>
<td><p>068, 142</p></td>
</tr>
<tr class="row-even"><td><p>``
+``
068</p></td>
<td><p>040, 067</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>073</p></td>
<td><p>049</p></td>
<td><p>050</p></td>
</tr>
<tr class="row-even"><td><p>076</p></td>
<td></td>
<td><p>146, 155</p></td>
</tr>
<tr class="row-odd"><td><p>077</p></td>
<td></td>
<td><p>155</p></td>
</tr>
<tr class="row-even"><td><p>078</p></td>
<td><p>008</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>080</p></td>
<td><p>042</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>081</p></td>
<td><p>049</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>129</p></td>
<td></td>
<td><p>134, 135, 148, 152, 165, 192</p></td>
</tr>
<tr class="row-even"><td><p>134</p></td>
<td><p>129</p></td>
<td><p>152, 192</p></td>
</tr>
<tr class="row-odd"><td><p>135</p></td>
<td><p>129</p></td>
<td><p>148</p></td>
</tr>
<tr class="row-even"><td><p>139</p></td>
<td><p>025, 028</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>``
+``
142</p></td>
<td><p>067</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>146</p></td>
<td><p>076</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>148</p></td>
<td><p>129, 135</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>149</p></td>
<td><p>014</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>152</p></td>
<td><p>129, 134</p></td>
<td><p>192</p></td>
</tr>
<tr class="row-even"><td><p>155</p></td>
<td><p>076, 077</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>165</p></td>
<td><p>129</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>192</p></td>
<td><p>129, 134, 152</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>193</p></td>
<td><p>(PER-3)</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>194</p></td>
<td><p>051</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>196</p></td>
<td></td>
<td><p>197</p></td>
</tr>
<tr class="row-even"><td><p>197</p></td>
<td><p>196</p></td>
<td></td>
</tr>
</tbody>
</table>
</center><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span>    <span class="n">For</span> <span class="n">facility</span> <span class="n">bits</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">:</span> <span class="n">see</span> <span class="n">pages</span> <span class="n">vii</span> <span class="ow">and</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ow">and</span> <span class="n">reference</span> <span class="mi">7</span> <span class="n">on</span> <span class="n">page</span> <span class="n">viii</span>
     <span class="n">of</span> <span class="n">manual</span> <span class="n">SA23</span><span class="o">-</span><span class="mi">2260</span><span class="o">-</span><span class="mi">05</span> <span class="s2">&quot;Load-Program-Parameter and CPU-Measurement Facilities&quot;</span><span class="o">.</span>

     <span class="n">For</span> <span class="n">facility</span> <span class="n">bits</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">142</span><span class="p">:</span> <span class="n">see</span> <span class="n">reference</span> <span class="mi">10</span> <span class="n">on</span> <span class="n">page</span> <span class="n">xxxii</span> <span class="n">of</span> <span class="n">manual</span> <span class="n">SA22</span><span class="o">-</span><span class="mi">7832</span><span class="o">-</span><span class="mi">13</span>
     <span class="s2">&quot;z/Architecture Principles of Operation&quot;</span><span class="o">.</span>
</pre></div>
</div>
<center></section>
<section id="facility-incompatibilities">
<h3>Facility Incompatibilities<a class="headerlink" href="#facility-incompatibilities" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Bit</p></th>
<th class="head"><p>Incompatible with …</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+</span></code> 002</p></td>
<td><p>168</p></td>
</tr>
<tr class="row-odd"><td><p>010</p></td>
<td><p>169</p></td>
</tr>
<tr class="row-even"><td><p>014</p></td>
<td><p>169</p></td>
</tr>
<tr class="row-odd"><td><p>066</p></td>
<td><p>169</p></td>
</tr>
<tr class="row-even"><td><p>145</p></td>
<td><p>169</p></td>
</tr>
<tr class="row-odd"><td><p>149</p></td>
<td><p>169</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+</span></code> 168</p></td>
<td><p>002</p></td>
</tr>
<tr class="row-odd"><td><p>169</p></td>
<td><p>010, 014, 066, 145, 149</p></td>
</tr>
</tbody>
</table>
</center><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span>    <span class="n">For</span> <span class="n">facility</span> <span class="n">bits</span> <span class="mi">002</span> <span class="ow">and</span> <span class="mi">168</span><span class="p">:</span> <span class="n">either</span> <span class="n">bit</span> <span class="n">may</span> <span class="n">be</span> <span class="n">on</span><span class="p">,</span> <span class="ow">or</span> <span class="n">neither</span> <span class="n">bit</span> <span class="n">may</span> <span class="n">be</span> <span class="n">on</span><span class="p">,</span>
     <span class="n">but</span> <span class="n">both</span> <span class="n">bits</span> <span class="n">can</span> <span class="n">never</span> <span class="n">be</span> <span class="n">on</span> <span class="n">at</span> <span class="n">the</span> <span class="n">same</span> <span class="n">time</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="d-instrxxx-update-opcode-table-functions">
<h3>5d. <code class="docutils literal notranslate"><span class="pre">instrxxx</span></code> Update Opcode Table functions<a class="headerlink" href="#d-instrxxx-update-opcode-table-functions" title="Permalink to this heading">¶</a></h3>
<p>For those facilities which introduce new z/Architecture instructions to
go along with the facility, the <code class="docutils literal notranslate"><span class="pre">instrxxx</span></code> function (defined as the
second parameter of the <code class="docutils literal notranslate"><span class="pre">`FT2</span></code> &lt;#5b-The-FT2-table&gt;`__ table) defines
the list of instructions that only exist when the given facility is
enabled.</p>
<p>The function is called by the <code class="docutils literal notranslate"><span class="pre">init_facilities_lists</span></code> function at
Hercules startup (as well as by the <code class="docutils literal notranslate"><span class="pre">facility</span></code> command too whenever a
facility is manually enabled or disabled) to patch (update) the
<code class="docutils literal notranslate"><span class="pre">opcode.c</span></code> instruction table to either enable or disable the given set
of instructions depending on whether the given facility is enabled or
disabled for that architecture.</p>
<p>This eliminates the need for each individual instruction from having to
manually check whether the given facility is enabled or not (via the
<code class="docutils literal notranslate"><span class="pre">FACILITY_ENABLED(</span> <span class="pre">...</span> <span class="pre">)</span></code> macro) and then having to manually call the
<code class="docutils literal notranslate"><span class="pre">program_interrupt</span></code> function to throw an operation exception if it’s
not. Instead, this is all handled automatically by each facility’s
defined <code class="docutils literal notranslate"><span class="pre">instrxxx</span></code> function, which looks like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">instr21</span><span class="w">  </span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">arch</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="p">);</span>

<span class="p">...</span>

<span class="n">BEG_DIS_FAC_INS_FUNC</span><span class="p">(</span><span class="w"> </span><span class="n">instr21</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DIS_FAC_INS</span><span class="p">(</span><span class="w"> </span><span class="n">C208</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AGFI    C208  ADD IMMEDIATE (64 &lt;- 32)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">DIS_FAC_INS</span><span class="p">(</span><span class="w"> </span><span class="n">C209</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AFI     C209  ADD IMMEDIATE (32)&quot;</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="p">...</span><span class="n">etc</span><span class="p">...</span>

<span class="w">    </span><span class="n">DIS_FAC_INS</span><span class="p">(</span><span class="w"> </span><span class="n">B907</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LGHR    B907  LOAD HALFWORD (64 &lt;- 16)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">DIS_FAC_INS</span><span class="p">(</span><span class="w"> </span><span class="n">B927</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LHR     B927  LOAD HALFWORD (32 &lt;- 16)&quot;</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="p">...</span><span class="n">etc</span><span class="p">...</span>

<span class="w">    </span><span class="n">DIS_FAC_INS</span><span class="p">(</span><span class="w"> </span><span class="n">C204</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SLGFI   C204  SUBTRACT LOGICAL IMMEDIATE (64 &lt;- 32)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">DIS_FAC_INS</span><span class="p">(</span><span class="w"> </span><span class="n">C205</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SLFI    C205  SUBTRACT LOGICAL IMMEDIATE (32)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>
<span class="n">END_DIS_FAC_INS_FUNC</span><span class="p">()</span>
</pre></div>
</div>
<p>The first parameter of the <code class="docutils literal notranslate"><span class="pre">DIS_FAC_INS</span></code> macro is obviously the
instruction’s hexadecimal opcode, and the second parameter is simply a
unique descriptive name for that particular instruction.</p>
</section>
</section>
<section id="coding-the-facility-instructions-themselves">
<h2>6. Coding the facility instructions themselves<a class="headerlink" href="#coding-the-facility-instructions-themselves" title="Permalink to this heading">¶</a></h2>
<p>Implementing a new instruction in Hercules involves updating three
source files: the <a class="reference external" href="../opcode.h">opcode.h</a> header (which declares its
existence), the <a class="reference external" href="../opcode.c">opcode.c</a> instruction dispatch table
(directing the <code class="docutils literal notranslate"><span class="pre">run_cpu</span></code> instruction execution loop in
<a class="reference external" href="../cpu.c">cpu.c</a> to jump to the actual instruction function itself),
and of course the actual instruction function itself (which does not
necessarily have to be in source file <code class="docutils literal notranslate"><span class="pre">esame.c</span></code> but may instead be in
a completely different source file, possibly its own).</p>
<section id="a-def-inst-in-opcode-h">
<h3>6a. <code class="docutils literal notranslate"><span class="pre">DEF_INST</span></code> in <code class="docutils literal notranslate"><span class="pre">opcode-h</span></code><a class="headerlink" href="#a-def-inst-in-opcode-h" title="Permalink to this heading">¶</a></h3>
<p>Within header file <a class="reference external" href="../opcode.h">opcode.h</a>, simply insert a new
<code class="docutils literal notranslate"><span class="pre">DEF_INST</span></code> macro for your new instruction, guarded with the
appropriate <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">defined(</span> <span class="pre">FEATURE_999_xxxx...)</span></code> statement (where
<code class="docutils literal notranslate"><span class="pre">_999_xxx...</span></code> is of course the named of the <code class="docutils literal notranslate"><span class="pre">FEATURE</span></code> macro you
defined in your <code class="docutils literal notranslate"><span class="pre">`feat900.h</span></code> &lt;../feat900.h&gt;`__ header):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined( FEATURE_049_PROCESSOR_ASSIST_FACILITY )</span>
<span class="n">DEF_INST</span><span class="p">(</span><span class="w"> </span><span class="n">perform_processor_assist</span><span class="w"> </span><span class="p">);</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="b-undef-inst-and-genx-x-x900-in-opcode-c">
<h3>6b. <code class="docutils literal notranslate"><span class="pre">UNDEF_INST</span></code> and <code class="docutils literal notranslate"><span class="pre">GENx___x___x900</span></code> in <code class="docutils literal notranslate"><span class="pre">opcode-c</span></code><a class="headerlink" href="#b-undef-inst-and-genx-x-x900-in-opcode-c" title="Permalink to this heading">¶</a></h3>
<p>Within the <a class="reference external" href="../opcode.c">opcode.c</a> source file, insert a
<code class="docutils literal notranslate"><span class="pre">UNDEF_INST</span></code> macro for your new instruction guarded with an
appropriate #if !defined( FEATURE_999_xxxx…) statement:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if !defined( FEATURE_049_PROCESSOR_ASSIST_FACILITY )</span>
<span class="w"> </span><span class="n">UNDEF_INST</span><span class="p">(</span><span class="w"> </span><span class="n">perform_processor_assist</span><span class="w"> </span><span class="p">);</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>Then about halfway down, update the appropriate <code class="docutils literal notranslate"><span class="pre">GENx___x___x900</span></code>
macro statement for your instruction’s opcode, defining the name of your
instruction function, the instruction’s decoder format and its mnemonic:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*B2E8*/</span><span class="w"> </span><span class="n">GENx___x___x900</span><span class="w"> </span><span class="p">(</span><span class="n">perform_processor_assist</span><span class="p">,</span><span class="n">RRF_M</span><span class="p">,</span><span class="s">&quot;PPA&quot;</span><span class="p">),</span>
</pre></div>
</div>
<p>Note that each <code class="docutils literal notranslate"><span class="pre">x___</span></code> spot in the macro’s name corresponds to a given
build architecture. The first <code class="docutils literal notranslate"><span class="pre">x___</span></code> being replaced with <code class="docutils literal notranslate"><span class="pre">x370</span></code> if
the given instruction is defined to the System/370 architecture, the
second being replaced with <code class="docutils literal notranslate"><span class="pre">x390</span></code> if the instruction is defined to the
ESA/390 architecture and the third spot being replaced with <code class="docutils literal notranslate"><span class="pre">x900</span></code> if
the instruction is defined to z/Architecture. The <code class="docutils literal notranslate"><span class="pre">/*B2E8*/</span></code> is of
course just a helpful comment documenting the instruction’s opcode.</p>
</section>
<section id="c-the-actual-esame-c-instruction-function-itself">
<h3>6c. The actual <code class="docutils literal notranslate"><span class="pre">esame-c</span></code> instruction function itself<a class="headerlink" href="#c-the-actual-esame-c-instruction-function-itself" title="Permalink to this heading">¶</a></h3>
<p>Depending on its complexity, this is perhaps the easiest part: coding
the actual instruction function itself.</p>
<p>All you need to be careful to do is to wrap (guard) your function with
the appropriate <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">defined(</span> <span class="pre">FEATURE_999_xxx...)</span></code> and <code class="docutils literal notranslate"><span class="pre">#endif</span></code>
statements so that it is only compiled if that particular FEATURE is
#defined for the given build architecture:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined( FEATURE_021_EXTENDED_IMMED_FACILITY )</span>

<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="cm">/* B907 LGHR  - Load Long Halfword Register                    [RRE] */</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>
<span class="n">DEF_INST</span><span class="p">(</span><span class="w"> </span><span class="n">load_long_halfword_register</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">int</span><span class="w">     </span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">r2</span><span class="p">;</span><span class="w">                         </span><span class="cm">/* Values of R fields        */</span>

<span class="w">    </span><span class="n">RRE</span><span class="p">(</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Load sign-extended halfword from second operand register */</span>
<span class="w">    </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">GR_G</span><span class="p">(</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">S64</span><span class="p">)(</span><span class="n">S16</span><span class="p">)(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">GR_LHL</span><span class="p">(</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="p">));</span>

<span class="p">}</span><span class="w"> </span><span class="cm">/* end DEF_INST( load_long_halfword_register ) */</span>

<span class="cp">#endif </span><span class="cm">/* defined( FEATURE_021_EXTENDED_IMMED_FACILITY ) */</span>
</pre></div>
</div>
<p><strong>Please note</strong> that under normal circumstances there is no need to code
any <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(FACILITY_ENABLED(</span> <span class="pre">...</span> <span class="pre">))</span></code> test anywhere in your instruction
if your instruction is only defined when the given facility is enabled,
as this is handled automatically by the associated <code class="docutils literal notranslate"><span class="pre">facility.c</span></code>
<code class="docutils literal notranslate"><span class="pre">`BEG_DIS_FAC_INS_FUNC</span></code>
function &lt;#5d-instrxxx-Update-Opcode-Table-functions&gt;`__ (controlled by
the <code class="docutils literal notranslate"><span class="pre">`instrxxx</span></code> &lt;#5d-instrxxx-Update-Opcode-Table-functions&gt;`__ second
parameter of the <code class="docutils literal notranslate"><span class="pre">`FT2</span></code> &lt;#5b-The-FT2-table&gt;`__ table.)</p>
<p>When the facility is enabled, the instruction is defined and will be
called. When the facility is <em>not</em> enabled, the instruction is <em>not</em>
defined and will automatically program-check if the guest attempts to
execute it. That’s one of the primary purposes of the code in
<code class="docutils literal notranslate"><span class="pre">`facility.c</span></code> &lt;../facility.c&gt;`__.</p>
<p>Thus you can be assured that if your instruction is called, the
corresponding facility is indeed enabled. Otherwise your instruction
function would never have been called! Thus any use of
<code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(FACILITY_ENABLED(</span> <span class="pre">...</span> <span class="pre">))</span></code> statement is completely unnecessary.</p>
<p><em>The</em> <strong>only</strong> <em>time you</em> <strong>might</strong> <em>need to</em> code a
<code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(FACILITY_ENABLED(</span> <span class="pre">...</span> <span class="pre">))</span></code> statement is if the instruction in
question is defined to behave <em>differently</em> depending on whether a given
facility is enabled (installed) or not. For example, take a look at the
<code class="docutils literal notranslate"><span class="pre">IPTE</span></code> (Invalidate Page Table Entry) and <code class="docutils literal notranslate"><span class="pre">SSKE</span></code> (Set Storage Key
extended) instructions in <code class="docutils literal notranslate"><span class="pre">control.c</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">IPTE</span></code> instruction contains a <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(FACILITY_ENABLED(</span> <span class="pre">...</span> <span class="pre">))</span></code>
check for each of the <code class="docutils literal notranslate"><span class="pre">051_LOCAL_TLB_CLEARING</span></code> and <code class="docutils literal notranslate"><span class="pre">013_IPTE_RANGE</span></code>
facilities because it behaves differently depending on whether either of
those facilities is enabled or not.</p>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">SSKE</span></code> instruction contains a
<code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(FACILITY_ENABLED(</span> <span class="pre">...</span> <span class="pre">))</span></code> check for the <code class="docutils literal notranslate"><span class="pre">008_EDAT_1</span></code> facility
because it too behaves differently depending on whether that particular
facility is enabled or not.</p>
<p>These are likely the <em>only</em> times an instruction function might actually
need to use an <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(FACILITY_ENABLED(</span> <span class="pre">...</span> <span class="pre">))</span></code> statement.</p>
<p><strong>But the key point is,</strong> you <em>don’t</em> need to do any
<code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(FACILITY_ENABLED(</span> <span class="pre">...</span> <span class="pre">))</span></code> test simply to check whether or not
your <em>INSTRUCTION EXISTS</em> due to whether or not your facility is enabled
or not. <em>That</em> type of check (test) is handled automatically by the
<code class="docutils literal notranslate"><span class="pre">FT2</span></code> table’s second parameter and corresponding <code class="docutils literal notranslate"><span class="pre">instrxxx</span></code>
function.</p>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: fovea1959
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Languages</dt>
        
           <strong> 
          <dd><a href="/herc-docs-demo/en/fovea1959/">en</a></dd>
           </strong> 
        
      </dl>
      
      
      <dl>
        <dt>Versions</dt>
        
           <strong> 
          <dd><a href="/herc-docs-demo/en/fovea1959/">fovea1959</a></dd>
           </strong> 
        
          
          <dd><a href="/herc-docs-demo/en/master/">master</a></dd>
          
        
          
          <dd><a href="/herc-docs-demo/en/0.0/">0.0</a></dd>
          
        
          
          <dd><a href="/herc-docs-demo/en/1.0/">1.0</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="/herc-docs-demo/en/fovea1959/Hercules Documentation Demo-docs_en_fovea1959.pdf">pdf</a></dd>
        
          <dd><a href="/herc-docs-demo/en/fovea1959/Hercules Documentation Demo-docs_en_fovea1959.epub">epub</a></dd>
        
          <dd><a href="/herc-docs-demo/en/fovea1959/Hercules Documentation Demo-docs_en_fovea1959.html.tar.gz">tarred HTML</a></dd>
        
          <dd><a href="/herc-docs-demo/en/fovea1959/Hercules Documentation Demo-docs_en_fovea1959.single.html.tar.gz">tarred single file HTML</a></dd>
        
      </dl>
      
      
      <hr/>
      <a href="https://tech.michaelaltfield.net/2020/07/18/sphinx-rtd-github-pages-1/">Continuous Documentation</a> hosting provided by <a href="https://pages.github.com/">GitHub Pages</a>.
 
    </div>
  </div>

 

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>